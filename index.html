<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Painel • Listar Parcelas (F360)</title>
  <style>
    :root{ --bg:#f4f6f8; --card:#fff; --ink:#0f1724; --muted:#6b7280; --accent:#2563eb; --radius:10px }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,Arial;background:var(--bg);color:var(--ink);padding:18px}
    .card{background:var(--card);border-radius:var(--radius);box-shadow:0 6px 18px rgba(9,20,43,0.06);padding:16px;max-width:1100px;margin:8px auto}
    header{display:flex;gap:12px;align-items:center}
    h1{margin:0;font-size:18px}
    .controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
    input,select,button{padding:8px 10px;border-radius:8px;border:1px solid #e6edf3}
    button{background:var(--accent);color:#fff;border:none;cursor:pointer}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{padding:8px;border-bottom:1px solid #f1f5f9;text-align:left;font-size:14px}
    th{background:#fafcff}
    .meta{display:flex;gap:10px;align-items:center;margin-left:auto}
    .footer{display:flex;justify-content:space-between;align-items:center;margin-top:12px}
    .small{font-size:13px;color:var(--muted)}
    @media (max-width:760px){table{font-size:12px} .controls{flex-direction:column;align-items:stretch}}
  </style>
</head>
<body>
  <div class="card">
    <header>
      <div>
        <h1>Painel • Listar Parcelas (F360)</h1>
        <div class="small">Conecte ao F360 via token. Use Vercel + GitHub. Veja instruções no final.</div>
      </div>
      <div class="meta small">Status: <span id="status">inicializando...</span></div>
    </header>

    <div class="controls">
      <select id="empresaSelect">
        <option value="">-- Todas as empresas --</option>
        <!-- Substitua pelas empresas reais ou carregue dinamicamente -->
        <option value="Empresa A">Empresa A</option>
        <option value="Empresa B">Empresa B</option>
      </select>

      <input type="date" id="inicio" />
      <input type="date" id="fim" />

      <select id="tipoDatas">
        <option value="Emissão">Emissão</option>
        <option value="Vencimento">Vencimento</option>
      </select>

      <button id="btnLoad">Carregar parcelas</button>

      <div style="margin-left:auto;display:flex;gap:8px">
        <button id="btnLogin">Fazer login (server)</button>
        <button id="btnClear">Limpar token</button>
      </div>
    </div>

    <div id="tableWrap">
      <table id="parcelasTable">
        <thead>
          <tr><th>ID</th><th>Empresa</th><th>Fornecedor</th><th>Vencimento</th><th>Valor</th><th>Status</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="footer">
      <div class="small">Última atualização: <span id="lastUpdate">—</span></div>
      <div><span id="pageInfo" class="small"></span></div>
    </div>

    <pre id="debug" style="margin-top:12px;display:none;background:#0b1220;color:#e5f0ff;padding:8px;border-radius:8px;overflow:auto;max-height:140px"></pre>
  </div>

  <script>
    // ---------- CONFIG (editar antes da implantação) ----------
    // Front-end chama /api/login (serverless on Vercel). Você deve criar essa rota
    // com as variáveis de ambiente F360_INIT_TOKEN e F360_BASE_URL.
    const LOGIN_ENDPOINT = '/api/login' // serverless (você adiciona)
    // Caso queira testar localmente sem serverless, coloque o token inicial abaixo (NÃO recomendado em produção):
    // const DEBUG_INIT_TOKEN = 'ac0399fb-55dc-4c5c-bdde-0e3cf5943ac5'

    // ---------- estado ----------
    let jwt = null
    let jwtExpiresAt = 0

    const statusEl = document.getElementById('status')
    const debugEl = document.getElementById('debug')
    const lastUpdateEl = document.getElementById('lastUpdate')

    function setStatus(t){ statusEl.textContent = t }
    function dbg(o){ debugEl.style.display = 'block'; debugEl.textContent = JSON.stringify(o,null,2) }

    // Faz login chamando a rota server-side (não expõe credenciais no cliente)
    async function serverLogin(){
      setStatus('fazendo login...')
      try{
        const r = await fetch(LOGIN_ENDPOINT)
        if(!r.ok) throw new Error('login falhou: '+r.status)
        const data = await r.json()
        // Aceita várias formas de resposta: {token}, {jwt}, {accessToken}, {data:{token}}
        jwt = data.jwt || data.token || data.accessToken || (data.data && (data.data.token||data.data.jwt))
        // tenta extrair exp (segundos) se houver
        jwtExpiresAt = data.expiresAt || data.exp || 0
        if(!jwt){ setStatus('login ok (sem token retornado)'); dbg(data); return }
        setStatus('logado')
        scheduleRefresh()
        return data
      }catch(err){ setStatus('erro login'); dbg({err:err.message}); console.error(err) }
    }

    // Agenda refresh um pouco antes do expiry. Se não houver expiry, refresca a cada 25 minutos.
    let refreshTimer = null
    function scheduleRefresh(){
      if(refreshTimer) clearTimeout(refreshTimer)
      let ms = 25*60*1000 // default 25min
      if(jwtExpiresAt){
        const now = Date.now()/1000
        const secondsLeft = jwtExpiresAt - now
        // refresh 60s antes
        ms = Math.max((secondsLeft - 60)*1000, 20*1000)
      }
      refreshTimer = setTimeout(()=>{ serverLogin(); }, ms)
    }

    // Carrega parcelas a partir da API pública usando o jwt
    async function loadParcelas(params={pagina:1,tipo:'Despesa',inicio:'',fim:'',tipoDatas:'Emissão'}){
      if(!jwt){ setStatus('sem token, clique em "Fazer login"') ; return }
      setStatus('carregando parcelas...')

      // Construir URL (substitua {{URL}} pelo host base retornado pelo serverless, ou configure na função serverless)
      // Ex: https://financas.f360.com.br/ParcelasDeTituloPublicAPI/ListarParcelasDeTitulos
      const base = await getBaseUrl()
      const qs = new URLSearchParams(params)
      const url = base + '/ParcelasDeTituloPublicAPI/ListarParcelasDeTitulos?' + qs.toString()

      try{
        const r = await fetch(url, { headers: { 'Content-Type':'application/json', 'Authorization': 'Bearer '+jwt } })
        if(!r.ok){
          setStatus('erro ao buscar parcelas: '+r.status)
          const t = await r.text(); dbg({status:r.status, body:t}); return
        }
        const data = await r.json()
        renderTable(data)
        setStatus('parcelas carregadas')
        lastUpdateEl.textContent = new Date().toLocaleString()
      }catch(err){ setStatus('erro fetch'); dbg({err:err.message}); console.error(err) }
    }

    // Renderiza a resposta na tabela. Ajuste de acordo com o formato real da API.
    function renderTable(apiResp){
      const tbody = document.querySelector('#parcelasTable tbody')
      tbody.innerHTML = ''
      // A resposta típica pode ter {items: [...]} ou poder ser um array direto
      const items = apiResp.items || apiResp.data || apiResp || []
      if(!Array.isArray(items)){
        // tenta extrair de propriedades comuns
        for(const k in apiResp){ if(Array.isArray(apiResp[k])){ return renderTable(apiResp[k]) } }
        dbg(apiResp); return
      }
      if(items.length===0){ tbody.innerHTML = '<tr><td colspan="6">Nenhuma parcela encontrada</td></tr>'; return }

      for(const it of items){
        const tr = document.createElement('tr')
        const id = it.id || it.tituloId || it.parcelaId || it.cod || ''
        const empresa = it.empresa || it.filial || it.nomeEmpresa || ''
        const fornecedor = it.fornecedor || it.historico || it.nome || ''
        const venc = it.vencimento || it.dataVencimento || it.emissao || ''
        const valor = (it.valor || it.valorParcela || it.valorOriginal || '')
        const status = it.status || it.situacao || ''
        tr.innerHTML = `<td>${id}</td><td>${empresa}</td><td>${fornecedor}</td><td>${venc}</td><td>${valor}</td><td>${status}</td>`
        tbody.appendChild(tr)
      }
    }

    // Busca base url do server (para permitir troca do host sem mudar front-end)
    async function getBaseUrl(){
      // rota /api/login pode devolver também baseUrl; caso contrário altere aqui para o host correto.
      try{
        const r = await fetch('/api/login/meta')
        if(!r.ok) return ''
        const d = await r.json()
        return d.baseUrl || ''
      }catch(e){ return '' }
    }

    // eventos
    document.getElementById('btnLogin').addEventListener('click', ()=>serverLogin())
    document.getElementById('btnClear').addEventListener('click', ()=>{ jwt=null; jwtExpiresAt=0; setStatus('token limpo') })
    document.getElementById('btnLoad').addEventListener('click', ()=>{
      const empresa = document.getElementById('empresaSelect').value
      const inicio = document.getElementById('inicio').value
      const fim = document.getElementById('fim').value
      const tipoDatas = document.getElementById('tipoDatas').value
      const params = { pagina:1, tipo:'Despesa', inicio: inicio || '', fim: fim || '', tipoDatas: tipoDatas }
      if(empresa) params.empresa = empresa
      loadParcelas(params)
    })

    // Inicializa datas para hoje
    const hoje = new Date().toISOString().slice(0,10)
    document.getElementById('inicio').value = hoje
    document.getElementById('fim').value = hoje

    // tenta login automático ao abrir (chama serverless que usa variáveis de ambiente seguras)
    (async ()=>{ await serverLogin() })()

    // ---------------------------
    // Instruções para criar a rota serverless /api/login (Vercel)
    // ---------------------------
    /*
    // Crie um arquivo: /api/login.js (Node/Serverless em Vercel)

    export default async function handler(req, res){
      // Variáveis de ambiente (configurar no Vercel):
      // F360_INIT_TOKEN => token curto (ex: ac0399fb-... ) que você mostra no Postman
      // F360_BASE_URL  => https://financas.f360.com.br
      const INIT_TOKEN = process.env.F360_INIT_TOKEN
      const BASE_URL = process.env.F360_BASE_URL || 'https://financas.f360.com.br'

      if(!INIT_TOKEN) return res.status(500).json({error:'F360_INIT_TOKEN não definido'})

      try{
        // Faz POST para obter a chave maior (JWT)
        const r = await fetch(BASE_URL + '/PublicLoginAPI/DoLogin',{
          method:'POST',
          headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify({ token: INIT_TOKEN })
        })
        const data = await r.json()
        // Ex.: data = { token: 'JWT_LONG_TOKEN', expiresIn: 1800 }

        // Opcional: retornar também a baseUrl para o front-end
        res.status(200).json({ ...data, baseUrl: BASE_URL })
      }catch(err){
        res.status(500).json({ error: err.message })
      }
    }

    // NOTAS:
    // 1) NÃO coloque o INIT_TOKEN no front-end. Use a rota serverless para proteger a credencial.
    // 2) No Vercel: Settings -> Environment Variables -> adicionar F360_INIT_TOKEN e F360_BASE_URL
    // 3) Commitar /api/login.js junto com este index.html no seu repositório GitHub e conectar ao Vercel.
    // 4) Se a API de login devolver outro formato, adapte a extração do jwt no front-end.
    */

  </script>
</body>
</html>
